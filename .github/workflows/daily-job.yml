name: Daily Trading Pipeline

on:
  schedule:
    # Run at 6 AM ET (11 AM UTC) on weekdays
    - cron: '0 11 * * 1-5'
  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Full data refresh (slower)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ============================================
  # Update Market Data
  # ============================================
  update-market-data:
    name: Update Market Data
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run market data update
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FULL_REFRESH: ${{ github.event.inputs.full_refresh || 'false' }}
        run: |
          cd backend
          python jobs/market_data_job.py --full

  # ============================================
  # Update Sentiment Data
  # ============================================
  update-sentiment:
    name: Update Sentiment Data
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: update-market-data

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run sentiment update
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: |
          cd backend
          python jobs/sentiment_job.py --full

  # ============================================
  # Collect Macro Data
  # ============================================
  collect-macro-data:
    name: Collect Macro Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: update-sentiment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run macro data collection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          cd backend
          python -c "
          import asyncio
          from jobs.macro_data_job import run_macro_data_job
          from database import get_supabase_client
          db = get_supabase_client()
          result = asyncio.run(run_macro_data_job(db))
          print(f'Macro data job complete: {result}')
          "

  # ============================================
  # Calculate Factor Scores
  # ============================================
  calculate-factors:
    name: Calculate Factor Scores
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: collect-macro-data

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run factor scoring
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cd backend
          python jobs/factor_scoring_job.py

  # ============================================
  # Process Agent Trades
  # ============================================
  process-agents:
    name: Process Agent Trades
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: calculate-factors

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run strategy execution for all active agents
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
        run: |
          cd backend
          python jobs/strategy_execution_job.py

  # ============================================
  # Generate Daily Reports
  # ============================================
  generate-reports:
    name: Generate Daily Reports
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: process-agents

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Generate reports for all active agents
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd backend
          python jobs/report_generation_job.py

  # ============================================
  # Notify on Failure
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [update-market-data, update-sentiment, collect-macro-data, calculate-factors, process-agents, generate-reports]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Daily job failed - implement notification (email/slack) here"
