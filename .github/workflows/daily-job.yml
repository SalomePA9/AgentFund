name: Daily Market Data Update

on:
  schedule:
    # Run at 6 AM ET (11 AM UTC) on weekdays
    - cron: '0 11 * * 1-5'
  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Full data refresh (slower)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ============================================
  # Update Market Data
  # ============================================
  update-market-data:
    name: Update Market Data
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run market data update
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FULL_REFRESH: ${{ github.event.inputs.full_refresh || 'false' }}
        run: |
          cd backend
          python jobs/market_data_job.py --full

  # ============================================
  # Update Sentiment Data
  # ============================================
  update-sentiment:
    name: Update Sentiment Data
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: update-market-data

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run sentiment update
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: |
          cd backend
          python -c "
          # Sentiment update script
          # Will be implemented in Phase 2
          print('Sentiment update job placeholder')
          "

  # ============================================
  # Process Agent Trades
  # ============================================
  process-agents:
    name: Process Agent Trades
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: update-sentiment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run agent processing
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd backend
          python -c "
          # Agent processing script
          # Will be implemented in Week 1.5
          print('Agent processing job placeholder')
          "

  # ============================================
  # Generate Daily Reports
  # ============================================
  generate-reports:
    name: Generate Daily Reports
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: process-agents

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Generate reports
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd backend
          python -c "
          # Report generation script
          # Will be implemented in Phase 2
          print('Report generation job placeholder')
          "

  # ============================================
  # Notify on Failure
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [update-market-data, update-sentiment, process-agents, generate-reports]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Daily job failed - implement notification (email/slack) here"
