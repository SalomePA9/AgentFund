name: Preview Deploy

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Deploy Frontend Preview to Vercel
  # ============================================
  preview-frontend:
    name: Frontend Preview
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Vercel token
        id: check-token
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "::warning::VERCEL_TOKEN not configured â€” skipping preview deploy"
          else
            echo "available=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Vercel CLI
        if: steps.check-token.outputs.available == 'true'
        run: npm install -g vercel

      - name: Pull Vercel environment
        if: steps.check-token.outputs.available == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd frontend
          vercel pull --yes --environment=preview --token=$VERCEL_TOKEN

      - name: Deploy preview
        id: deploy
        if: steps.check-token.outputs.available == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd frontend
          DEPLOY_URL=$(vercel deploy --token=$VERCEL_TOKEN 2>&1 | grep -oP 'https://[^\s]+\.vercel\.app' | head -1)
          if [ -z "$DEPLOY_URL" ]; then
            DEPLOY_URL=$(vercel deploy --token=$VERCEL_TOKEN)
          fi
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "Preview deployed to: $DEPLOY_URL"

  # ============================================
  # Post Preview URL as PR Comment
  # ============================================
  comment-preview:
    name: Post Preview Link
    runs-on: ubuntu-latest
    needs: [preview-frontend]
    if: needs.preview-frontend.outputs.url != ''
    permissions:
      pull-requests: write

    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Preview Deployment'

      - name: Post or update preview comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## Preview Deployment

            | Service | URL |
            |---------|-----|
            | Frontend | ${{ needs.preview-frontend.outputs.url }} |

            _Updated for commit ${{ github.event.pull_request.head.sha }}_
